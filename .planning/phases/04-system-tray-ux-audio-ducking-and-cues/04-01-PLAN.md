---
phase: 04-system-tray-ux-audio-ducking-and-cues
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - agenttalk/tray.py
  - agenttalk/audio_duck.py
  - requirements.txt
autonomous: true
requirements:
  - TRAY-01
  - TRAY-02
  - TRAY-03
  - TRAY-04
  - TRAY-05
  - TRAY-06
  - AUDIO-07

must_haves:
  truths:
    - "tray.py exports build_tray_icon(state) returning a pystray.Icon with correct menu structure"
    - "The tray menu has: Mute toggle with checked=lambda reflecting state['muted'], Voice submenu with radio=True per voice, active voice info item with enabled=False, separator, Quit item"
    - "create_image_idle() and create_image_speaking() both return PIL Image objects of size 64x64"
    - "audio_duck.py exports AudioDucker class with duck() and unduck() methods"
    - "AudioDucker.duck() calls comtypes.CoInitialize(), enumerates sessions, skips python processes, saves original volumes, sets volumes to original * 0.5"
    - "AudioDucker.unduck() calls comtypes.CoInitialize(), restores saved volumes from the duck() call, then clears _saved"
    - "Both duck() and unduck() wrap pycaw calls in try/except so a pycaw failure logs a warning and does not crash the TTS worker"
    - "pystray>=0.19.5 and pycaw>=20251023 appear in requirements.txt"
  artifacts:
    - path: "agenttalk/tray.py"
      provides: "build_tray_icon(state), create_image_idle(), create_image_speaking()"
      exports: ["build_tray_icon", "create_image_idle", "create_image_speaking"]
    - path: "agenttalk/audio_duck.py"
      provides: "AudioDucker class with duck() and unduck() methods"
      exports: ["AudioDucker"]
  key_links:
    - from: "agenttalk/service.py"
      to: "agenttalk/tray.py"
      via: "from agenttalk.tray import build_tray_icon, create_image_idle, create_image_speaking"
      pattern: "from agenttalk\\.tray import"
    - from: "agenttalk/tts_worker.py"
      to: "agenttalk/audio_duck.py"
      via: "from agenttalk.audio_duck import AudioDucker"
      pattern: "from agenttalk\\.audio_duck import"
---

<objective>
Create two new standalone modules: tray.py (pystray tray icon with dynamic menu) and audio_duck.py (pycaw-based per-session audio ducking).

Purpose: These are the building blocks for Phase 4 UX. tray.py provides the icon, both states (idle/speaking), and the full right-click menu. audio_duck.py provides the COM-safe ducking/restoring of other Windows audio sessions. Both modules are self-contained and testable in isolation before being wired into service.py and tts_worker.py in Plan 04-02.

Output: agenttalk/tray.py, agenttalk/audio_duck.py, requirements.txt updated with pystray and pycaw.
</objective>

<execution_context>
@C:/Users/omern/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omern/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-system-tray-ux-audio-ducking-and-cues/04-RESEARCH.md

<python_version_blocker>
STATE.md records: "[Phase 4]: Python 3.11 must be installed before pystray integration (3.12 GIL crash)"

Before writing any pystray code, test whether pystray 0.19.5 crashes under the project's actual usage on the current Python version:

```bash
python -c "
import pystray
from PIL import Image, ImageDraw

def _make_img():
    img = Image.new('RGBA', (64, 64), (0,0,0,0))
    ImageDraw.Draw(img).ellipse([4,4,60,60], fill=(30,120,200,255))
    return img

icon = pystray.Icon('test', _make_img())
icon.run(setup=lambda ic: ic.stop())
print('pystray OK')
"
```

- If this prints "pystray OK" → proceed with the current Python version.
- If this produces a fatal GIL crash (process-level abort, no Python traceback) → install Python 3.11 before continuing. Record the outcome in the plan summary.

The research indicates the GIL crash is confirmed with PySimpleGUI+psgtray+PyGame stacks. Pure pystray on 3.12 with Icon.run(setup=fn) + ic.stop() may work. Test first; do NOT assume a crash.
</python_version_blocker>

<interfaces>
<!-- Key patterns from 04-RESEARCH.md — no codebase exploration needed beyond what is listed here. -->

From 04-RESEARCH.md (Creating Two Icon Images):
```python
from PIL import Image, ImageDraw

def create_image_idle(size: int = 64) -> Image.Image:
    """Blue circle — idle state."""
    image = Image.new("RGBA", (size, size), (0, 0, 0, 0))
    dc = ImageDraw.Draw(image)
    dc.ellipse([4, 4, size - 4, size - 4], fill=(30, 120, 200, 255))
    return image

def create_image_speaking(size: int = 64) -> Image.Image:
    """Orange/red circle — TTS actively playing."""
    image = Image.new("RGBA", (size, size), (0, 0, 0, 0))
    dc = ImageDraw.Draw(image)
    dc.ellipse([4, 4, size - 4, size - 4], fill=(220, 80, 20, 255))
    return image
```

CRITICAL — minimum icon size 64x64: PIL images smaller than ~20x20px trigger "OSError: [WinError 0]"
in pystray's LoadImage call. Always use size=64 as default (research pitfall #5).

From 04-RESEARCH.md (Full Tray Icon Setup with Menu):
```python
import pystray

KOKORO_VOICES = [
    "af_heart", "af_bella", "af_nicole", "af_sarah", "af_sky",
    "am_adam", "am_michael", "bf_emma", "bf_isabella", "bm_george", "bm_lewis",
]

def build_tray_icon(state: dict) -> pystray.Icon:
    def _toggle_mute(icon):
        state["muted"] = not state["muted"]
        icon.update_menu()

    def _set_voice(voice):
        def _inner(icon, item):
            state["voice"] = voice
            icon.update_menu()
        return _inner

    def _quit(icon, item):
        _unduck_all()          # restore any ducked sessions before exit
        icon.stop()

    menu = pystray.Menu(
        pystray.MenuItem(
            "Mute",
            _toggle_mute,
            checked=lambda item: state["muted"],
        ),
        pystray.MenuItem(
            "Voice",
            pystray.Menu(lambda: (
                pystray.MenuItem(
                    voice,
                    _set_voice(voice),
                    checked=lambda item, v=voice: state["voice"] == v,
                    radio=True,
                )
                for voice in KOKORO_VOICES
            )),
        ),
        pystray.MenuItem(
            lambda item: f'Active: {state["voice"]}',
            lambda icon, item: None,
            enabled=False,
        ),
        pystray.Menu.SEPARATOR,
        pystray.MenuItem("Quit", _quit),
    )

    return pystray.Icon(
        "AgentTalk",
        icon=create_image_idle(),
        title="AgentTalk",
        menu=menu,
    )
```

NOTE on _unduck_all() in _quit: tray.py does NOT know about AudioDucker directly.
The quit handler receives an optional `on_quit` callable injected at build time.
Change the signature to: `build_tray_icon(state: dict, on_quit: callable = None) -> pystray.Icon`
The _quit function calls `on_quit()` if provided, then `icon.stop()`.
This keeps tray.py decoupled from audio_duck.py.

NOTE on TRAY-06 MenuItem with enabled=False: Some pystray versions raise TypeError when action=None.
Use `lambda icon, item: None` as the action (not bare None) to avoid the crash (research pitfall #3).

From 04-RESEARCH.md (Audio Ducking with pycaw):
```python
import comtypes
from pycaw.pycaw import AudioUtilities

class AudioDucker:
    def __init__(self):
        self._saved: dict[str, float] = {}   # process_name -> original volume

    def duck(self):
        """Lower all non-AgentTalk audio sessions to 50%."""
        comtypes.CoInitialize()
        try:
            sessions = AudioUtilities.GetAllSessions()
            self._saved.clear()
            for session in sessions:
                if session.Process is None:
                    continue  # System Sounds session — skip
                name = session.Process.name()
                if name.lower() in ("python.exe", "pythonw.exe"):
                    continue  # Skip ourselves
                vol = session.SimpleAudioVolume
                original = vol.GetMasterVolume()
                self._saved[name] = original
                vol.SetMasterVolume(original * 0.5, None)
        finally:
            comtypes.CoUninitialize()

    def unduck(self):
        """Restore all previously ducked sessions."""
        comtypes.CoInitialize()
        try:
            sessions = AudioUtilities.GetAllSessions()
            for session in sessions:
                if session.Process is None:
                    continue
                name = session.Process.name()
                if name in self._saved:
                    vol = session.SimpleAudioVolume
                    vol.SetMasterVolume(self._saved[name], None)
        finally:
            comtypes.CoUninitialize()
```

CRITICAL — comtypes.CoInitialize() in daemon threads: The TTS worker is a daemon thread.
COM is NOT initialized automatically in non-main threads. Every call to pycaw MUST be
wrapped with CoInitialize()/CoUninitialize(). Failure causes COMError: CO_E_NOTINITIALIZED
(research pitfall #2).

CRITICAL — wrap duck/unduck in try/except: Audio ducking is a best-effort feature.
If pycaw raises any exception (COM error, no audio sessions, locked device), log a warning
and continue — do NOT let a ducking failure crash the TTS worker.
Wrap the inner pycaw logic in try/except Exception before the finally: CoUninitialize().

IMPORTANT — session identity: Key on process name (str). Sessions may be created/destroyed
between duck() and unduck() calls. This edge case (e.g., Spotify restarted during TTS) is
accepted — user can adjust volume manually. (Research open question #2.)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Python/pystray compatibility then create agenttalk/tray.py</name>
  <files>agenttalk/tray.py, requirements.txt</files>
  <action>
    **Step 0: Install pystray and test compatibility.**

    ```bash
    cd /d/docker/claudetalk && pip install "pystray>=0.19.5"
    ```

    Then run the compatibility test from the python_version_blocker section:
    ```bash
    python -c "
    import pystray
    from PIL import Image, ImageDraw

    def _make_img():
        img = Image.new('RGBA', (64, 64), (0,0,0,0))
        ImageDraw.Draw(img).ellipse([4,4,60,60], fill=(30,120,200,255))
        return img

    icon = pystray.Icon('test', _make_img())
    icon.run(setup=lambda ic: ic.stop())
    print('pystray OK')
    "
    ```

    - If prints "pystray OK": proceed.
    - If fatal crash (no Python traceback, process aborts): install Python 3.11, update the venv, and rerun. Record outcome in the summary.

    Add `pystray>=0.19.5` to requirements.txt (append after existing entries).

    **Step 1: Create agenttalk/tray.py.**

    Implement the full module with:

    - Module-level `KOKORO_VOICES` list with all 11 voices:
      `["af_heart", "af_bella", "af_nicole", "af_sarah", "af_sky", "am_adam", "am_michael", "bf_emma", "bf_isabella", "bm_george", "bm_lewis"]`

    - `create_image_idle(size: int = 64) -> Image.Image`: RGBA image, blue circle (30, 120, 200, 255), ellipse from (4,4) to (size-4, size-4). Size MUST default to 64 (not 16 or 32 — WinError 0 pitfall).

    - `create_image_speaking(size: int = 64) -> Image.Image`: RGBA image, orange/red circle (220, 80, 20, 255), same ellipse bounds.

    - `build_tray_icon(state: dict, on_quit: callable = None) -> pystray.Icon`: builds and returns the Icon object (does NOT call icon.run() — that is service.py's job).

      Menu structure (TRAY-02, TRAY-04, TRAY-05, TRAY-06):
      1. MenuItem("Mute", _toggle_mute, checked=lambda item: state["muted"]) — TRAY-02
      2. MenuItem("Voice", Menu(lambda: generator of per-voice MenuItems with radio=True)) — TRAY-04
      3. MenuItem(lambda item: f'Active: {state["voice"]}', lambda icon, item: None, enabled=False) — TRAY-06
      4. Menu.SEPARATOR
      5. MenuItem("Quit", _quit) — TRAY-05

      _quit implementation:
      ```python
      def _quit(icon, item):
          if on_quit is not None:
              try:
                  on_quit()
              except Exception:
                  logging.warning("on_quit callback raised exception", exc_info=True)
          icon.stop()
      ```

      Icon construction:
      ```python
      return pystray.Icon(
          "AgentTalk",
          icon=create_image_idle(),
          title="AgentTalk",
          menu=menu,
      )
      ```

    DO NOT call icon.run() inside tray.py. DO NOT set icon.visible inside tray.py.
    Both are done by service.py's setup callback (research pattern #1).
    DO NOT use action=None for disabled menu items — use `lambda icon, item: None` (research pitfall #3).
  </action>
  <verify>
    **Import check:**
    ```bash
    cd /d/docker/claudetalk && python -c "
    from agenttalk.tray import build_tray_icon, create_image_idle, create_image_speaking, KOKORO_VOICES
    idle = create_image_idle()
    speaking = create_image_speaking()
    print('idle size:', idle.size)
    print('speaking size:', speaking.size)
    print('voices count:', len(KOKORO_VOICES))
    state = {'muted': False, 'voice': 'af_heart'}
    icon = build_tray_icon(state)
    print('icon name:', icon.name)
    print('tray.py OK')
    "
    ```
    Expected output:
    - `idle size: (64, 64)`
    - `speaking size: (64, 64)`
    - `voices count: 11`
    - `icon name: AgentTalk`
    - `tray.py OK`
  </verify>
  <done>
    agenttalk/tray.py exists. Imports cleanly. create_image_idle() and create_image_speaking() return (64,64) RGBA images. build_tray_icon(state) returns a pystray.Icon named "AgentTalk". KOKORO_VOICES has 11 entries. requirements.txt includes pystray>=0.19.5.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agenttalk/audio_duck.py and install pycaw</name>
  <files>agenttalk/audio_duck.py, requirements.txt</files>
  <action>
    **Step 0: Install pycaw.**
    ```bash
    cd /d/docker/claudetalk && pip install "pycaw>=20251023"
    ```
    Add `pycaw>=20251023` to requirements.txt (append after pystray line).

    **Step 1: Create agenttalk/audio_duck.py.**

    Implement the AudioDucker class exactly as specified in the interfaces section, with these additional safety requirements:

    The duck() method body (inside comtypes.CoInitialize()/CoUninitialize()) must be wrapped in try/except Exception to catch pycaw errors gracefully:
    ```python
    def duck(self) -> None:
        """Lower all non-AgentTalk audio sessions to 50%. Best-effort — logs on failure."""
        comtypes.CoInitialize()
        try:
            self._saved.clear()
            sessions = AudioUtilities.GetAllSessions()
            for session in sessions:
                if session.Process is None:
                    continue
                name = session.Process.name()
                if name.lower() in ("python.exe", "pythonw.exe"):
                    continue
                vol = session.SimpleAudioVolume
                original = vol.GetMasterVolume()
                if original > 0.0:
                    self._saved[name] = original
                    vol.SetMasterVolume(original * 0.5, None)
                    logging.debug("Ducked %s: %.2f → %.2f", name, original, original * 0.5)
        except Exception:
            logging.warning("Audio ducking failed — continuing without duck.", exc_info=True)
        finally:
            comtypes.CoUninitialize()
    ```

    The unduck() method body must similarly be wrapped in try/except Exception:
    ```python
    def unduck(self) -> None:
        """Restore all previously ducked sessions to saved volume."""
        if not self._saved:
            return  # Nothing was ducked — skip COM initialization entirely
        comtypes.CoInitialize()
        try:
            sessions = AudioUtilities.GetAllSessions()
            for session in sessions:
                if session.Process is None:
                    continue
                name = session.Process.name()
                if name in self._saved:
                    vol = session.SimpleAudioVolume
                    vol.SetMasterVolume(self._saved[name], None)
                    logging.debug("Restored %s → %.2f", name, self._saved[name])
            self._saved.clear()
        except Exception:
            logging.warning("Audio un-ducking failed.", exc_info=True)
        finally:
            comtypes.CoUninitialize()
    ```

    Add an `is_ducked` property for observability:
    ```python
    @property
    def is_ducked(self) -> bool:
        return bool(self._saved)
    ```

    Module-level import block:
    ```python
    import logging
    import comtypes
    from pycaw.pycaw import AudioUtilities
    ```

    The module must NOT import pystray or tray.py — zero coupling between audio_duck.py and tray.py.
  </action>
  <verify>
    **Import check:**
    ```bash
    cd /d/docker/claudetalk && python -c "
    from agenttalk.audio_duck import AudioDucker
    d = AudioDucker()
    print('AudioDucker created OK')
    print('is_ducked:', d.is_ducked)
    print('audio_duck.py OK')
    "
    ```
    Expected output:
    - `AudioDucker created OK`
    - `is_ducked: False`
    - `audio_duck.py OK`

    **Structural check — confirm no pystray coupling:**
    ```bash
    cd /d/docker/claudetalk && python -c "
    import ast, pathlib
    src = pathlib.Path('agenttalk/audio_duck.py').read_text()
    tree = ast.parse(src)
    imports = [n for n in ast.walk(tree) if isinstance(n, (ast.Import, ast.ImportFrom))]
    names = [getattr(n, 'module', None) or (n.names[0].name if n.names else '') for n in imports]
    assert 'pystray' not in names, 'pystray must not be imported in audio_duck.py'
    print('No pystray coupling — OK')
    "
    ```
    Prints "No pystray coupling — OK".
  </verify>
  <done>
    agenttalk/audio_duck.py exists. AudioDucker imports cleanly. duck() and unduck() are defined. is_ducked property returns False on a fresh instance. No pystray import. requirements.txt includes pycaw>=20251023.
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

**1. Both modules import cleanly:**
```bash
cd /d/docker/claudetalk && python -c "
from agenttalk.tray import build_tray_icon, create_image_idle, create_image_speaking, KOKORO_VOICES
from agenttalk.audio_duck import AudioDucker
print('All Phase 4 module imports OK')
"
```
Prints "All Phase 4 module imports OK" with no errors.

**2. Icon images meet minimum size requirement (pitfall #5):**
```bash
cd /d/docker/claudetalk && python -c "
from agenttalk.tray import create_image_idle, create_image_speaking
idle = create_image_idle()
speaking = create_image_speaking()
assert idle.size[0] >= 64 and idle.size[1] >= 64, f'idle image too small: {idle.size}'
assert speaking.size[0] >= 64 and speaking.size[1] >= 64, f'speaking image too small: {speaking.size}'
print('Icon size check passed:', idle.size, speaking.size)
"
```
Prints "Icon size check passed: (64, 64) (64, 64)".

**3. requirements.txt updated:**
```bash
grep -i "pystray\|pycaw" /d/docker/claudetalk/requirements.txt
```
Both pystray and pycaw lines appear.

**4. Existing tests still pass (regression):**
```bash
cd /d/docker/claudetalk && python -m pytest tests/ -v --ignore=tests/test_hooks.py
```
(test_hooks.py requires Phase 3 hooks already present — if they exist run full suite.)
All pre-existing tests pass.
</verification>

<success_criteria>
- agenttalk/tray.py exists with build_tray_icon, create_image_idle, create_image_speaking, KOKORO_VOICES
- create_image_idle() returns (64, 64) RGBA PIL image with blue ellipse
- create_image_speaking() returns (64, 64) RGBA PIL image with orange/red ellipse
- build_tray_icon(state) returns a pystray.Icon named "AgentTalk" — does NOT call icon.run() or set icon.visible
- build_tray_icon menu has: Mute (checked=muted), Voice submenu (11 voices, radio=True), Active voice info item (enabled=False, action=lambda not None), SEPARATOR, Quit
- agenttalk/audio_duck.py exists with AudioDucker class
- AudioDucker.duck() wraps pycaw in try/except and calls comtypes.CoInitialize/CoUninitialize
- AudioDucker.unduck() wraps pycaw in try/except, restores saved volumes, calls comtypes.CoInitialize/CoUninitialize
- AudioDucker.is_ducked property returns bool
- audio_duck.py has no pystray import
- requirements.txt has pystray>=0.19.5 and pycaw>=20251023
- Python/pystray compatibility verified (GIL crash test run and outcome recorded in summary)
</success_criteria>

<output>
After completion, create `.planning/phases/04-system-tray-ux-audio-ducking-and-cues/04-01-SUMMARY.md`
</output>
