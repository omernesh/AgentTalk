---
phase: 05-configuration-voice-model-switching-and-slash-commands
plan: "03"
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - agenttalk/commands/start.md
  - agenttalk/commands/stop.md
  - agenttalk/commands/voice.md
  - agenttalk/commands/model.md
autonomous: true
requirements:
  - CMD-01
  - CMD-02
  - CMD-03
  - CMD-04

must_haves:
  truths:
    - "agenttalk/commands/ directory exists with four .md files: start.md, stop.md, voice.md, model.md"
    - "Each .md file has valid frontmatter with name, description, disable-model-invocation: true, and allowed-tools: Bash"
    - "stop.md runs `curl -s -X POST http://localhost:5050/stop --max-time 3 || true` and treats connection-reset as success"
    - "voice.md runs a curl POST to /config with {\"voice\": \"$ARGUMENTS\"} and reports success or service-not-running"
    - "model.md runs a curl POST to /config with {\"model\": \"$ARGUMENTS\"} and reports success, error (Piper not configured), or service-not-running"
    - "start.md checks /health first; if service is running says so; if not, launches via pythonw using the path files in APPDATA"
    - "agenttalk/commands/README.md (or inline comments) explains that agenttalk setup (Phase 6) copies these files to ~/.claude/commands/agenttalk/ and describes how to install them manually during development"
  artifacts:
    - path: "agenttalk/commands/start.md"
      provides: "Source for /agenttalk:start slash command — checks health, launches service if down (CMD-01)"
    - path: "agenttalk/commands/stop.md"
      provides: "Source for /agenttalk:stop slash command — POSTs to /stop, handles connection reset (CMD-02)"
    - path: "agenttalk/commands/voice.md"
      provides: "Source for /agenttalk:voice [name] slash command — POSTs to /config with voice key (CMD-03)"
    - path: "agenttalk/commands/model.md"
      provides: "Source for /agenttalk:model [kokoro|piper] slash command — POSTs to /config with model key (CMD-04)"
  key_links:
    - from: "agenttalk/commands/stop.md"
      to: "agenttalk/service.py POST /stop"
      via: "curl -X POST http://localhost:5050/stop"
      pattern: "localhost:5050/stop"
    - from: "agenttalk/commands/voice.md"
      to: "agenttalk/service.py POST /config"
      via: "curl -X POST http://localhost:5050/config -d '{\"voice\": \"$ARGUMENTS\"}'"
      pattern: "localhost:5050/config"
    - from: "agenttalk/commands/model.md"
      to: "agenttalk/service.py POST /config"
      via: "curl -X POST http://localhost:5050/config -d '{\"model\": \"$ARGUMENTS\"}'"
      pattern: "localhost:5050/config"
---

<objective>
Create the four Claude Code slash command Markdown files that control AgentTalk from the terminal.

Purpose: Slash commands are the user-facing interface for Phase 5. Plan 05-01 built the service endpoints (/config, /stop) these commands call. These Markdown files live in agenttalk/commands/ in the project. Phase 6 (agenttalk setup) will copy them to ~/.claude/commands/agenttalk/ so they work globally. During development, the user can symlink or copy them manually.

Output: agenttalk/commands/start.md, stop.md, voice.md, model.md — ready to be copied to ~/.claude/commands/agenttalk/ by Phase 6.
</objective>

<execution_context>
@C:/Users/omern/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/omern/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-voice-model-switching-and-slash-commands/05-RESEARCH.md
@.planning/phases/05-configuration-voice-model-switching-and-slash-commands/05-01-SUMMARY.md

<interfaces>
<!-- Slash command file conventions from research. No codebase exploration needed. -->

Claude Code slash command namespace convention (from 05-RESEARCH.md):
- File at ~/.claude/commands/agenttalk/stop.md → registers command /agenttalk:stop
- The directory name is the namespace; the filename (without .md) is the command name
- Phase 5 creates source files in agenttalk/commands/ (project directory)
- Phase 6 copies them to ~/.claude/commands/agenttalk/ for global availability

Frontmatter fields used:
```yaml
---
name: stop
description: One-line description shown in /agenttalk: command list
argument-hint: [argument]       # Optional — shown in command UI
disable-model-invocation: true  # Prevents Claude from reasoning before running bash
allowed-tools: Bash             # Claude uses Bash tool to run the command
---
```

Service endpoints (from Plan 05-01):
- POST http://localhost:5050/stop          → silences + terminates service
- POST http://localhost:5050/config        → updates STATE key(s), saves config.json
  - body: {"voice": "af_bella"}           → CMD-03
  - body: {"model": "piper"}              → CMD-04
- GET  http://localhost:5050/health        → {"status": "ok"} when ready, connection refused when down

Service process launch pattern (from session_start_hook.py and 05-RESEARCH.md):
```python
import subprocess, os
from pathlib import Path
appdata = Path(os.environ['APPDATA']) / 'AgentTalk'
pythonw = (appdata / 'pythonw_path.txt').read_text().strip()
service = (appdata / 'service_path.txt').read_text().strip()
subprocess.Popen(
    [pythonw, service],
    creationflags=0x00000008 | 0x00000200,  # DETACHED_PROCESS | CREATE_NEW_PROCESS_GROUP
    close_fds=True,
    stdin=subprocess.DEVNULL,
    stdout=subprocess.DEVNULL,
    stderr=subprocess.DEVNULL,
)
```

/stop connection-reset pitfall (from 05-RESEARCH.md Pitfall 6):
The service calls os._exit(0) with a 0.1s delay (Plan 05-01). Use `|| true` in the curl
command so the Bash tool exits 0 regardless of curl's exit code. Instruct Claude to
interpret connection-reset as success ("service stopped"), not as an error.

/model Piper-not-configured error (from 05-RESEARCH.md Pitfall 3):
If the user switches to Piper but no model is downloaded, /config returns:
{"status": "error", "reason": "Piper model path not configured..."}
The model.md command must display this error reason to the user.

Kokoro voice list (from REQUIREMENTS.md and codebase):
af_heart, af_bella, af_nicole, af_sarah, af_sky, am_adam, am_michael,
bf_emma, bf_isabella, bm_george, bm_lewis
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agenttalk/commands/ directory and stop.md + voice.md + model.md</name>
  <files>agenttalk/commands/stop.md, agenttalk/commands/voice.md, agenttalk/commands/model.md</files>
  <action>
    Create the directory `agenttalk/commands/` and three of the four slash command files.

    **File 1: agenttalk/commands/stop.md**

    ```markdown
    ---
    name: stop
    description: Stop the AgentTalk TTS service and silence any current audio
    disable-model-invocation: true
    allowed-tools: Bash
    ---

    Stop the AgentTalk service.

    Run this command:
    ```bash
    curl -s -X POST http://localhost:5050/stop --max-time 3 || true
    ```

    If the command succeeds and returns `{"status": "stopped"}`, say "AgentTalk service stopped."
    If the connection was refused (service was already stopped), say "AgentTalk service was not running."
    If the connection was reset mid-request (service stopped while responding — this is normal), say "AgentTalk service stopped."
    ```

    **File 2: agenttalk/commands/voice.md**

    ```markdown
    ---
    name: voice
    description: "Switch the AgentTalk TTS voice. Available: af_heart, af_bella, af_nicole, af_sarah, af_sky, am_adam, am_michael, bf_emma, bf_isabella, bm_george, bm_lewis"
    argument-hint: [voice-name]
    disable-model-invocation: true
    allowed-tools: Bash
    ---

    Switch the AgentTalk TTS voice to $ARGUMENTS.

    Run this command:
    ```bash
    curl -s -X POST http://localhost:5050/config \
      -H "Content-Type: application/json" \
      -d "{\"voice\": \"$ARGUMENTS\"}" \
      --max-time 5
    ```

    If the response contains `"status": "ok"`, say "Voice switched to $ARGUMENTS. The next utterance will use this voice."
    If the connection is refused, say "AgentTalk service is not running. Start it with /agenttalk:start."
    ```

    **File 3: agenttalk/commands/model.md**

    ```markdown
    ---
    name: model
    description: "Switch the AgentTalk TTS engine. Options: kokoro (default), piper"
    argument-hint: [kokoro|piper]
    disable-model-invocation: true
    allowed-tools: Bash
    ---

    Switch the AgentTalk TTS engine to $ARGUMENTS.

    Run this command:
    ```bash
    curl -s -X POST http://localhost:5050/config \
      -H "Content-Type: application/json" \
      -d "{\"model\": \"$ARGUMENTS\"}" \
      --max-time 5
    ```

    If the response contains `"status": "ok"`, say "TTS engine switched to $ARGUMENTS. The next utterance will use this engine."
    If the response contains `"status": "error"`, display the reason from the response. If the reason mentions "Piper model path not configured", say "Piper model is not downloaded yet. Run 'agenttalk setup --piper' to download it."
    If the connection is refused, say "AgentTalk service is not running. Start it with /agenttalk:start."
    ```

    IMPORTANT — Markdown code fence escaping: The files above contain triple backtick code fences
    inside the Markdown body. When writing these files, use triple backtick (```) delimiters for the
    bash code blocks as shown. The frontmatter is delimited by `---` lines. The bash block and the
    overall file are separate levels — they do not conflict.
  </action>
  <verify>
    **All three files exist:**
    ```bash
    ls /d/docker/claudetalk/agenttalk/commands/
    ```
    Shows stop.md, voice.md, model.md.

    **stop.md has correct frontmatter and curl command:**
    ```bash
    grep -n "disable-model-invocation\|allowed-tools\|localhost:5050/stop" /d/docker/claudetalk/agenttalk/commands/stop.md
    ```
    Shows all three lines present.

    **voice.md references /config endpoint and $ARGUMENTS:**
    ```bash
    grep -n "localhost:5050/config\|\$ARGUMENTS" /d/docker/claudetalk/agenttalk/commands/voice.md
    ```
    Shows both present.

    **model.md references /config endpoint and handles error response:**
    ```bash
    grep -n "localhost:5050/config\|status.*error\|Piper model" /d/docker/claudetalk/agenttalk/commands/model.md
    ```
    Shows all three patterns present.
  </verify>
  <done>
    agenttalk/commands/ directory exists. stop.md, voice.md, model.md each have valid frontmatter (name, description, disable-model-invocation: true, allowed-tools: Bash) and correct curl commands targeting localhost:5050. stop.md uses `|| true` for connection-reset tolerance. model.md handles Piper-not-configured error response.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create agenttalk/commands/start.md and agenttalk/commands/__init__.py</name>
  <files>agenttalk/commands/start.md, agenttalk/commands/__init__.py</files>
  <action>
    **File 1: agenttalk/commands/start.md**

    The start command must first check if the service is already running (via /health), and only
    launch it if it is not. Launching uses the same pythonw_path.txt / service_path.txt pattern
    as session_start_hook.py (Phase 3).

    ```markdown
    ---
    name: start
    description: Start the AgentTalk TTS service if it is not already running
    disable-model-invocation: true
    allowed-tools: Bash
    ---

    Start the AgentTalk TTS service.

    First, check if it is already running:
    ```bash
    curl -s http://localhost:5050/health --max-time 2
    ```

    If the health check returns `"status": "ok"`, say "AgentTalk is already running."

    If the health check fails (connection refused or timeout), launch the service:
    ```bash
    python -c "
    import subprocess, os
    from pathlib import Path
    appdata = Path(os.environ['APPDATA']) / 'AgentTalk'
    pythonw = (appdata / 'pythonw_path.txt').read_text().strip()
    service = (appdata / 'service_path.txt').read_text().strip()
    subprocess.Popen(
        [pythonw, service],
        creationflags=0x00000008 | 0x00000200,
        close_fds=True,
        stdin=subprocess.DEVNULL,
        stdout=subprocess.DEVNULL,
        stderr=subprocess.DEVNULL,
    )
    print('Service launched')
    "
    ```

    If the launch command prints "Service launched", say "AgentTalk service is starting. It will be ready in about 10 seconds."
    If the launch command raises FileNotFoundError (pythonw_path.txt or service_path.txt missing), say "AgentTalk is not set up yet. Run 'agenttalk setup' to complete installation."
    ```

    **File 2: agenttalk/commands/__init__.py**

    Create an empty `__init__.py` so the commands directory is a valid Python package.
    This makes it consistent with other agenttalk subpackages (agenttalk/hooks/__init__.py exists).
    The file should contain only a docstring:

    ```python
    """
    AgentTalk slash command source files.

    These Markdown files define Claude Code slash commands under the /agenttalk: namespace.
    agenttalk setup (Phase 6) copies them to ~/.claude/commands/agenttalk/ for global use.

    Manual installation (development):
        mkdir -p ~/.claude/commands/agenttalk
        cp agenttalk/commands/*.md ~/.claude/commands/agenttalk/
    """
    ```
  </action>
  <verify>
    **start.md exists and has correct structure:**
    ```bash
    grep -n "disable-model-invocation\|allowed-tools\|localhost:5050/health\|pythonw_path" /d/docker/claudetalk/agenttalk/commands/start.md
    ```
    Shows all four patterns.

    **__init__.py exists:**
    ```bash
    ls /d/docker/claudetalk/agenttalk/commands/
    ```
    Shows start.md, stop.md, voice.md, model.md, __init__.py.

    **All four .md files have disable-model-invocation: true (security check):**
    ```bash
    grep -l "disable-model-invocation: true" /d/docker/claudetalk/agenttalk/commands/*.md
    ```
    Lists all four .md files — all must have this field.

    **All four .md files have allowed-tools: Bash:**
    ```bash
    grep -l "allowed-tools: Bash" /d/docker/claudetalk/agenttalk/commands/*.md
    ```
    Lists all four .md files.

    **Validate frontmatter structure of each file (name field present):**
    ```bash
    grep -h "^name:" /d/docker/claudetalk/agenttalk/commands/*.md
    ```
    Shows: name: start, name: stop, name: voice, name: model.
  </verify>
  <done>
    agenttalk/commands/ contains 5 files: start.md, stop.md, voice.md, model.md, __init__.py. start.md checks /health before launching, uses pythonw_path.txt / service_path.txt pattern, handles missing setup files gracefully. All four .md files have disable-model-invocation: true and allowed-tools: Bash. __init__.py documents the manual installation procedure.
  </done>
</task>

</tasks>

<verification>
Run after both tasks complete:

**1. All command files exist:**
```bash
ls /d/docker/claudetalk/agenttalk/commands/
```
Shows: __init__.py, model.md, start.md, stop.md, voice.md.

**2. All four .md files have required frontmatter fields:**
```bash
grep -l "disable-model-invocation: true" /d/docker/claudetalk/agenttalk/commands/*.md | wc -l
grep -l "allowed-tools: Bash" /d/docker/claudetalk/agenttalk/commands/*.md | wc -l
```
Both commands output `4`.

**3. Each command targets the correct endpoint:**
```bash
grep -h "localhost:5050" /d/docker/claudetalk/agenttalk/commands/*.md
```
Shows:
- stop.md → localhost:5050/stop
- voice.md → localhost:5050/config (voice key)
- model.md → localhost:5050/config (model key)
- start.md → localhost:5050/health

**4. stop.md uses `|| true` (connection-reset tolerance):**
```bash
grep "|| true" /d/docker/claudetalk/agenttalk/commands/stop.md
```
Shows the curl line with `|| true`.

**5. Simulate manual install and verify Claude Code would discover commands:**
```bash
# Verify the expected target directory path is documented in __init__.py
grep "~/.claude/commands/agenttalk" /d/docker/claudetalk/agenttalk/commands/__init__.py
```
Shows the manual installation instructions.

**6. Existing test suite passes:**
```bash
cd /d/docker/claudetalk && python -m pytest tests/ -v
```
All tests pass (new command .md files do not affect Python tests).
</verification>

<success_criteria>
- agenttalk/commands/ directory has 4 slash command .md files and __init__.py (CMD-01, CMD-02, CMD-03, CMD-04)
- All .md files have: name, description, disable-model-invocation: true, allowed-tools: Bash (required for autonomous bash execution)
- stop.md POSTs to localhost:5050/stop with --max-time 3 and || true — connection reset treated as success (CMD-02)
- voice.md POSTs to localhost:5050/config with {"voice": "$ARGUMENTS"} — reports success or service-not-running (CMD-03)
- model.md POSTs to localhost:5050/config with {"model": "$ARGUMENTS"} — reports success, Piper-not-configured error, or service-not-running (CMD-04)
- start.md checks /health first, launches via pythonw_path.txt pattern only if service is down, handles missing setup files gracefully (CMD-01)
- __init__.py documents the ~/.claude/commands/agenttalk/ target and manual installation procedure for development use
- All Phase 1-4 tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-voice-model-switching-and-slash-commands/05-03-SUMMARY.md`
</output>
