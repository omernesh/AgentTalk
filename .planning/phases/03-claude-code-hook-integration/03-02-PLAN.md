---
phase: 03-claude-code-hook-integration
plan: "02"
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - agenttalk/setup.py
  - tests/test_setup.py
autonomous: true
requirements:
  - HOOK-05

must_haves:
  truths:
    - "agenttalk/setup.py register_hooks() appends AgentTalk Stop hook entry into the existing Stop hooks array without removing or modifying any prior entries"
    - "agenttalk/setup.py register_hooks() appends AgentTalk SessionStart hook entry into the existing SessionStart hooks array without removing or modifying any prior entries"
    - "Running register_hooks() twice produces exactly one AgentTalk Stop entry and one AgentTalk SessionStart entry (idempotent)"
    - "register_hooks() writes settings.json with encoding='utf-8' (no BOM) via atomic tmp-then-replace"
    - "register_hooks() writes absolute paths to pythonw.exe and service.py into %APPDATA%\\AgentTalk\\pythonw_path.txt and service_path.txt"
    - "Both registered hook entries have async: true and timeout: 10"
    - "All unit tests in tests/test_setup.py pass with pytest"
  artifacts:
    - agenttalk/setup.py
    - tests/test_setup.py
  key_links:
    - "setup.py writes %APPDATA%\\AgentTalk\\pythonw_path.txt — consumed by session_start_hook.py (Plan 01)"
    - "setup.py writes %APPDATA%\\AgentTalk\\service_path.txt — consumed by session_start_hook.py (Plan 01)"
    - "Registered hook commands point to absolute paths of agenttalk/hooks/stop_hook.py and agenttalk/hooks/session_start_hook.py (created in Plan 01)"
---

<objective>
Create agenttalk/setup.py with the register_hooks() function that merges AgentTalk hook entries into ~/.claude/settings.json without overwriting existing hooks, plus supporting path files and unit tests.

Purpose: HOOK-05 requires hook registration to be automated — no manual JSON editing. The user already has existing Stop and SessionStart hooks (gsd hooks, sound hooks) that must be preserved. This setup module is the foundation for Phase 6's `agenttalk setup` CLI command.

Output: agenttalk/setup.py, tests/test_setup.py
</objective>

@agenttalk/hooks/stop_hook.py
@agenttalk/hooks/session_start_hook.py

## Context

The user's existing `~/.claude/settings.json` has this structure (verified from live file):

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "powershell -Command \"...\""
          }
        ]
      }
    ],
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "node \"C:/Users/omern/.claude/hooks/gsd-check-update.js\""
          }
        ]
      }
    ]
  }
}
```

AgentTalk entries must be appended to the inner `hooks` arrays, NOT added as new top-level matcher group objects. The final merged structure must be:

```json
{
  "hooks": {
    "Stop": [
      {
        "hooks": [
          { "type": "command", "command": "...existing..." },
          { "type": "command", "command": "\"C:\\...\\pythonw.exe\" \"C:\\...\\stop_hook.py\"", "async": true, "timeout": 10 }
        ]
      }
    ],
    "SessionStart": [
      {
        "hooks": [
          { "type": "command", "command": "node ...existing..." },
          { "type": "command", "command": "\"C:\\...\\pythonw.exe\" \"C:\\...\\session_start_hook.py\"", "async": true, "timeout": 10 }
        ]
      }
    ]
  }
}
```

**Critical constraints from research:**
- Write settings.json with `encoding='utf-8'` — NOT `utf-8-sig`. BOM causes Claude Code JSON parse failure.
- Idempotency check: search inner hooks array for any command containing both 'agenttalk' (case-insensitive) and the hook filename. If found, skip — do not add a duplicate.
- Atomic write: write to a `.json.tmp` file first, then `Path.replace()` to move it into place. Prevents half-written settings.json if interrupted.
- Path discovery: `pythonw.exe` absolute path = `sys.executable` with `python.exe` replaced by `pythonw.exe` (they live in the same Scripts/ directory). `service.py` path = resolved from the setup.py file's own location.

---

<task>
<name>create-setup-module</name>
<type>auto</type>
<files>
  - agenttalk/setup.py
</files>
<action>
Create `agenttalk/setup.py` with the `register_hooks()` function and path file writing.

```python
"""
AgentTalk setup module.
Registers Claude Code hooks and writes path files for hook scripts.

Requirements: HOOK-05
Called by: agenttalk setup CLI command (Phase 6) or directly: python -m agenttalk.setup
"""
import json
import os
import sys
from pathlib import Path

# ~/.claude/settings.json — user-scope hooks apply to all Claude Code projects
SETTINGS_PATH = Path.home() / '.claude' / 'settings.json'

# %APPDATA%\AgentTalk\ — service runtime directory (created by Phase 1)
APPDATA = Path(os.environ.get('APPDATA', Path.home() / 'AppData' / 'Roaming'))
AGENTTALK_DIR = APPDATA / 'AgentTalk'

# Hook scripts live in agenttalk/hooks/ relative to this file
_THIS_DIR = Path(__file__).parent
HOOKS_DIR = _THIS_DIR / 'hooks'
STOP_HOOK_PATH = HOOKS_DIR / 'stop_hook.py'
SESSION_START_HOOK_PATH = HOOKS_DIR / 'session_start_hook.py'
SERVICE_PATH = _THIS_DIR / 'service.py'


def _get_pythonw_path() -> Path:
    """
    Return the absolute path to pythonw.exe in the current Python environment.
    pythonw.exe lives in the same directory as python.exe (Scripts/ in a venv).
    Falls back to 'pythonw' (PATH lookup) if pythonw.exe is not found beside python.exe.
    """
    python_exe = Path(sys.executable)
    pythonw_candidate = python_exe.parent / 'pythonw.exe'
    if pythonw_candidate.exists():
        return pythonw_candidate
    # Fallback: try same name pattern on non-standard installations
    return Path('pythonw')


def _write_path_files(pythonw: Path) -> None:
    """
    Write absolute paths into %APPDATA%\\AgentTalk\\ so session_start_hook.py
    can find pythonw.exe and service.py without importing from the agenttalk package.
    """
    AGENTTALK_DIR.mkdir(parents=True, exist_ok=True)
    (AGENTTALK_DIR / 'pythonw_path.txt').write_text(
        str(pythonw.resolve()), encoding='utf-8'
    )
    (AGENTTALK_DIR / 'service_path.txt').write_text(
        str(SERVICE_PATH.resolve()), encoding='utf-8'
    )


def _build_hook_command(pythonw: Path, hook_script: Path) -> str:
    """
    Build the hook command string with absolute paths, quoted for Windows shell.
    Format: "C:\\path\\pythonw.exe" "C:\\path\\hook.py"
    """
    return f'"{pythonw.resolve()}" "{hook_script.resolve()}"'


def _is_agenttalk_hook_present(inner_hooks: list, hook_filename: str) -> bool:
    """
    Return True if any existing hook command references agenttalk and the hook filename.
    Case-insensitive to handle mixed-case Windows paths.
    Idempotency: prevents duplicate registration.
    """
    for hook in inner_hooks:
        cmd = hook.get('command', '').lower()
        if 'agenttalk' in cmd and hook_filename.lower() in cmd:
            return True
    return False


def _merge_hook_into_array(
    matcher_groups: list,
    hook_entry: dict,
    hook_filename: str,
) -> None:
    """
    Append hook_entry into the inner hooks array of the FIRST matcher group,
    unless an agenttalk entry for this hook is already present (idempotent).

    The settings.json structure is:
      "Stop": [                          <- matcher_groups (list of matcher objects)
        {                                <- matcher_groups[0]
          "hooks": [                     <- inner hooks array
            { "type": "command", ... }   <- individual hook entries
          ]
        }
      ]
    """
    if not matcher_groups:
        # No existing matcher group — create one
        matcher_groups.append({'hooks': [hook_entry]})
        return

    first_group = matcher_groups[0]
    inner_hooks = first_group.setdefault('hooks', [])

    if _is_agenttalk_hook_present(inner_hooks, hook_filename):
        return  # Already registered — skip

    inner_hooks.append(hook_entry)


def register_hooks(
    pythonw: Path | None = None,
    settings_path: Path | None = None,
) -> None:
    """
    Merge AgentTalk hooks into ~/.claude/settings.json without overwriting
    existing hook entries. Idempotent: running twice produces exactly one entry.

    Args:
        pythonw: Override pythonw.exe path (for testing). Defaults to auto-detected path.
        settings_path: Override settings.json path (for testing). Defaults to ~/.claude/settings.json.
    """
    if pythonw is None:
        pythonw = _get_pythonw_path()
    if settings_path is None:
        settings_path = SETTINGS_PATH

    # Write path files for session_start_hook.py to consume at runtime
    _write_path_files(pythonw)

    # Load existing settings (or start from empty dict if file doesn't exist)
    settings: dict = {}
    if settings_path.exists():
        raw = settings_path.read_text(encoding='utf-8')
        settings = json.loads(raw)

    hooks_section = settings.setdefault('hooks', {})

    # Build hook entries
    stop_entry = {
        'type': 'command',
        'command': _build_hook_command(pythonw, STOP_HOOK_PATH),
        'async': True,
        'timeout': 10,
    }
    session_entry = {
        'type': 'command',
        'command': _build_hook_command(pythonw, SESSION_START_HOOK_PATH),
        'async': True,
        'timeout': 10,
    }

    # Merge into existing Stop and SessionStart arrays
    stop_groups = hooks_section.setdefault('Stop', [])
    _merge_hook_into_array(stop_groups, stop_entry, 'stop_hook.py')

    session_groups = hooks_section.setdefault('SessionStart', [])
    _merge_hook_into_array(session_groups, session_entry, 'session_start_hook.py')

    # Atomic write — write to .tmp then replace to avoid half-written settings.json
    # CRITICAL: encoding='utf-8' (NOT 'utf-8-sig') — BOM breaks Claude Code JSON parser
    tmp_path = settings_path.with_suffix('.json.tmp')
    tmp_path.write_text(json.dumps(settings, indent=2), encoding='utf-8')
    tmp_path.replace(settings_path)

    print(f"AgentTalk hooks registered in {settings_path}")
    print(f"  Stop hook: {STOP_HOOK_PATH.resolve()}")
    print(f"  SessionStart hook: {SESSION_START_HOOK_PATH.resolve()}")


if __name__ == '__main__':
    register_hooks()
```
</action>
<verify>
  <automated>cd /d/docker/claudetalk && python -c "import ast; ast.parse(open('agenttalk/setup.py').read()); print('Syntax OK')"</automated>
</verify>
<done>agenttalk/setup.py exists, parses without errors, exports register_hooks(), _merge_hook_into_array(), _is_agenttalk_hook_present(), and _write_path_files() functions ready for testing.</done>
</task>

<task>
<name>write-setup-unit-tests</name>
<type>auto</type>
<files>
  - tests/test_setup.py
</files>
<action>
Create `tests/test_setup.py` with pytest unit tests for `agenttalk/setup.py`. Use `tmp_path` fixture for all file I/O. Do NOT modify the real `~/.claude/settings.json` or `%APPDATA%\AgentTalk\`.

**Test the following scenarios:**

1. **test_register_hooks_fresh_settings**: settings.json does not exist yet. Call `register_hooks(pythonw=fake_pythonw, settings_path=tmp_path/'settings.json')`. Assert the written file contains both a Stop entry and a SessionStart entry with `async: true` and `timeout: 10` and the command contains 'stop_hook.py' / 'session_start_hook.py'.

2. **test_register_hooks_preserves_existing_stop**: settings.json has an existing Stop hooks array with a powershell command. After register_hooks(), the powershell command entry still exists AND the AgentTalk entry is also present. Total Stop inner hooks count = 2.

3. **test_register_hooks_preserves_existing_session_start**: settings.json has an existing SessionStart hooks array with a node command. After register_hooks(), the node command entry still exists AND the AgentTalk entry is also present. Total SessionStart inner hooks count = 2.

4. **test_register_hooks_idempotent_stop**: Call register_hooks() twice with the same settings.json. Assert the Stop inner hooks array contains exactly 1 AgentTalk entry (not 2).

5. **test_register_hooks_idempotent_session_start**: Call register_hooks() twice. Assert SessionStart inner hooks array contains exactly 1 AgentTalk entry.

6. **test_settings_json_no_bom**: After register_hooks(), read the settings.json file in binary mode. Assert the first bytes are NOT the UTF-8 BOM (`b'\xef\xbb\xbf'`).

7. **test_settings_json_valid_json**: After register_hooks(), read the settings.json as text with encoding='utf-8' and parse with json.loads() — assert no exception.

8. **test_write_path_files**: Call `_write_path_files(fake_pythonw)` with patched AGENTTALK_DIR pointing to tmp_path. Assert pythonw_path.txt and service_path.txt exist and contain the expected absolute paths.

**Test structure:**

```python
import json
import sys
from pathlib import Path
from unittest.mock import patch, MagicMock
import pytest

# Import the setup module
sys.path.insert(0, str(Path(__file__).parent.parent))
from agenttalk.setup import register_hooks, _write_path_files, _is_agenttalk_hook_present, _merge_hook_into_array

EXISTING_SETTINGS = {
    "hooks": {
        "Stop": [
            {
                "hooks": [
                    {
                        "type": "command",
                        "command": "powershell -Command \"Start-Sound.ps1\""
                    }
                ]
            }
        ],
        "SessionStart": [
            {
                "hooks": [
                    {
                        "type": "command",
                        "command": "node \"C:/Users/omern/.claude/hooks/gsd-check-update.js\""
                    }
                ]
            }
        ]
    }
}
```

For each test that calls `register_hooks()`, patch `agenttalk.setup.AGENTTALK_DIR` to point to `tmp_path / 'appdata'` so path files are written there instead of the real APPDATA. Pass `settings_path=tmp_path/'settings.json'` directly.

The fake pythonw path should be `tmp_path / 'pythonw.exe'` (create the file with `touch()` so `Path.resolve()` works).

Count AgentTalk entries in inner hooks with:
```python
def _count_agenttalk_entries(inner_hooks: list, filename: str) -> int:
    return sum(1 for h in inner_hooks
               if 'agenttalk' in h.get('command', '').lower()
               and filename.lower() in h.get('command', '').lower())
```
</action>
<verify>
  <automated>cd /d/docker/claudetalk && python -m pytest tests/test_setup.py -v 2>&1</automated>
</verify>
<done>All 8 tests in tests/test_setup.py pass. Tests confirm: hook merging, preservation of existing hooks, idempotency (no duplicates), UTF-8 BOM absence, valid JSON output, and path file writing.</done>
</task>

---

## Verification

```
cd /d/docker/claudetalk && python -m pytest tests/ -v
```

Expected: All tests pass across test_preprocessor.py, test_hooks.py, and test_setup.py. No failures.

---

## Success Criteria

- `agenttalk/setup.py` exists with `register_hooks()` that merges AgentTalk hooks into `~/.claude/settings.json` without removing existing hooks
- Running `register_hooks()` twice produces exactly one AgentTalk Stop entry and one AgentTalk SessionStart entry (idempotent)
- Written settings.json is BOM-free UTF-8 (no `\xef\xbb\xbf` prefix)
- Written hook entries have `"async": true` and `"timeout": 10`
- `%APPDATA%\AgentTalk\pythonw_path.txt` and `service_path.txt` contain absolute paths after setup runs
- `tests/test_setup.py` exists and all 8 unit tests pass
- HOOK-05 requirement satisfied
