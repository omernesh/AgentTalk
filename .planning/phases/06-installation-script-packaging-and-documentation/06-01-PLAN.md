---
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - agenttalk/cli.py
  - agenttalk/installer.py
  - requirements.txt
autonomous: true
---

# Plan 06-01: Package Manifest, CLI Entry Point, and Installer Module

## Goal

Ship a pip-installable package by writing `pyproject.toml`, `agenttalk/cli.py`, and `agenttalk/installer.py`. After this plan, `pip install .` registers the `agenttalk` command and `agenttalk setup` downloads the Kokoro model, registers hooks, and creates a desktop shortcut.

## Requirements Covered

- INST-01: `pip install agenttalk` installs the package and CLI entry point
- INST-02: `agenttalk setup` downloads Kokoro ONNX model to `%APPDATA%\AgentTalk\models\` with a progress bar
- INST-03: `agenttalk setup` registers Stop and SessionStart hooks without overwriting existing hooks
- INST-04: `agenttalk setup` creates a desktop shortcut (.lnk) pointing to the AgentTalk service launcher
- INST-05: `agenttalk setup` writes hook scripts using the absolute path to the venv's pythonw.exe
- INST-06: Install process works without administrator rights on Windows 11

## Context

The existing codebase already has:
- `agenttalk/setup.py` — `register_hooks()` and `_get_pythonw_path()` fully implemented
- `agenttalk/hooks/stop_hook.py` and `agenttalk/hooks/session_start_hook.py` — written in Phase 3
- `agenttalk/commands/*.md` — four slash command files written in Phase 5
- `agenttalk/service.py` — already has model path check that says "Run `agenttalk setup`"
- `requirements.txt` — lists all runtime deps (without requests, tqdm, pywin32, winshell)

The `pyproject.toml` must:
- Set `requires-python = ">=3.11,<3.12"` (pystray crashes on 3.12+ per STATE.md decision)
- Declare `agenttalk = "agenttalk.cli:main"` as the console_scripts entry point
- Include package-data for `agenttalk/commands/*.md` and `agenttalk/hooks/*.py`

## Tasks

<task id="06-01-T1" wave="1">
### Task 1: Create pyproject.toml

Create `D:/docker/claudetalk/pyproject.toml` with the full package declaration.

**Exact content to write:**

```toml
[build-system]
requires = ["setuptools>=68"]
build-backend = "setuptools.backends.legacy:build"

[project]
name = "agenttalk"
version = "1.0.0"
description = "Real-time TTS for Claude Code output — offline, local, no API keys"
readme = "README.md"
license = { text = "MIT" }
requires-python = ">=3.11,<3.12"
authors = [{ name = "omern" }]
keywords = ["tts", "claude", "claude-code", "text-to-speech", "kokoro"]
classifiers = [
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.11",
    "License :: OSI Approved :: MIT License",
    "Operating System :: Microsoft :: Windows",
]
dependencies = [
    "kokoro-onnx==0.5.0",
    "sounddevice>=0.5.5",
    "fastapi>=0.110",
    "uvicorn>=0.29",
    "psutil>=5.9",
    "pysbd==0.3.4",
    "pystray>=0.19.5",
    "pycaw>=20251023",
    "requests>=2.31",
    "tqdm>=4.66",
    "pywin32>=306; platform_system=='Windows'",
    "winshell>=0.6; platform_system=='Windows'",
]

[project.scripts]
agenttalk = "agenttalk.cli:main"

[project.urls]
Homepage = "https://github.com/omern/AgentTalk"
Repository = "https://github.com/omern/AgentTalk"

[tool.setuptools.packages.find]
where = ["."]

[tool.setuptools.package-data]
"agenttalk.commands" = ["*.md"]
"agenttalk.hooks" = ["*.py"]
```

**Key constraint:** `requires-python = ">=3.11,<3.12"` — pystray GIL crash on 3.12+ is documented in STATE.md and must be enforced at the package level.

<verify>
- `pyproject.toml` exists at `D:/docker/claudetalk/pyproject.toml`
- File contains `[build-system]`, `[project]`, `[project.scripts]`, `[tool.setuptools.package-data]` sections
- `agenttalk = "agenttalk.cli:main"` is present under `[project.scripts]`
- `requires-python = ">=3.11,<3.12"` is present
- All 12 dependencies listed: kokoro-onnx, sounddevice, fastapi, uvicorn, psutil, pysbd, pystray, pycaw, requests, tqdm, pywin32, winshell
- `"agenttalk.commands" = ["*.md"]` and `"agenttalk.hooks" = ["*.py"]` present under `[tool.setuptools.package-data]`
</verify>

<done>Done when `pyproject.toml` exists with the exact content specified above, verified by `python -c "import tomllib; d=tomllib.load(open('pyproject.toml','rb')); assert d['project']['scripts']['agenttalk']=='agenttalk.cli:main'; print('OK')"` printing `OK`.</done>
</task>

<task id="06-01-T2" wave="1">
### Task 2: Create agenttalk/installer.py

Create `D:/docker/claudetalk/agenttalk/installer.py` with `download_model()` and `create_shortcut()`.

**Exact content to write:**

```python
"""
AgentTalk installer module.

Provides:
  - download_model(): Download Kokoro ONNX model files to %APPDATA%\\AgentTalk\\models\\
  - create_shortcut(): Create AgentTalk.lnk on the Windows desktop

Requirements: INST-02, INST-04, INST-05, INST-06
Called by: agenttalk.cli._cmd_setup()
"""
import os
import sys
from pathlib import Path

import requests
from tqdm import tqdm

# ---------------------------------------------------------------------------
# Paths
# ---------------------------------------------------------------------------

APPDATA = Path(os.environ.get("APPDATA", Path.home() / "AppData" / "Roaming"))
MODELS_DIR = APPDATA / "AgentTalk" / "models"

# Kokoro v1.0 model files — hosted on GitHub releases under the stable tag
# model-files-v1.0 tag is the stable v1 release (see Phase 6 research pitfall 6)
MODEL_FILES: dict[str, str] = {
    "kokoro-v1.0.onnx": (
        "https://github.com/thewh1teagle/kokoro-onnx/releases/download/"
        "model-files-v1.0/kokoro-v1.0.onnx"
    ),
    "voices-v1.0.bin": (
        "https://github.com/thewh1teagle/kokoro-onnx/releases/download/"
        "model-files-v1.0/voices-v1.0.bin"
    ),
}


# ---------------------------------------------------------------------------
# Model download
# ---------------------------------------------------------------------------

def download_model() -> None:
    """
    Download Kokoro ONNX model files to %APPDATA%\\AgentTalk\\models\\.

    Skips files that already exist (idempotent).
    Uses streaming HTTP with tqdm progress bar.
    Raises requests.HTTPError on non-200 responses (e.g., HTTP 404 if URL changes).

    INST-02: Downloads kokoro-v1.0.onnx (~310MB) and voices-v1.0.bin to APPDATA models dir.
    INST-06: APPDATA paths require no admin rights on Windows 11.
    """
    MODELS_DIR.mkdir(parents=True, exist_ok=True)

    for filename, url in MODEL_FILES.items():
        dest = MODELS_DIR / filename
        if dest.exists():
            print(f"  {filename}: already present, skipping.")
            continue

        print(f"\nDownloading {filename}...")
        try:
            response = requests.get(url, stream=True, allow_redirects=True, timeout=30)
            response.raise_for_status()
        except requests.HTTPError as exc:
            print(
                f"\nERROR: Failed to download {filename}: {exc}\n"
                "If you see HTTP 404, the model URL may have changed.\n"
                "Check https://github.com/thewh1teagle/kokoro-onnx/releases for the latest URL."
            )
            raise

        total = int(response.headers.get("content-length", 0))
        with (
            open(dest, "wb") as f,
            tqdm(
                total=total,
                unit="B",
                unit_scale=True,
                unit_divisor=1024,
                desc=filename,
            ) as bar,
        ):
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
                bar.update(len(chunk))

        print(f"  Saved to {dest}")


# ---------------------------------------------------------------------------
# Desktop shortcut
# ---------------------------------------------------------------------------

def create_shortcut() -> None:
    """
    Create AgentTalk.lnk on the Windows desktop targeting pythonw.exe + service.py.

    Uses winshell.desktop() to resolve the true desktop path via Win32
    SHGetFolderPath — handles GPO-redirected desktops correctly.
    Falls back to python.exe if pythonw.exe is not found.
    Idempotent: overwrites existing shortcut on re-run.

    INST-04: Desktop shortcut creation.
    INST-05: Absolute path to venv's pythonw.exe embedded in the shortcut.
    INST-06: winshell creates .lnk files without admin rights.
    """
    try:
        import winshell  # type: ignore[import]
    except ImportError:
        print(
            "WARNING: winshell not available — skipping desktop shortcut creation.\n"
            "Install winshell with: pip install winshell pywin32"
        )
        return

    # Detect pythonw.exe alongside the current python.exe (venv-aware)
    python_exe = Path(sys.executable)
    pythonw = python_exe.parent / "pythonw.exe"
    if not pythonw.exists():
        # Fallback: no pythonw.exe in this environment (e.g., conda, some venvs)
        pythonw = python_exe
        print(f"  NOTE: pythonw.exe not found; shortcut will use {pythonw.name}")

    # service.py lives in the same directory as this installer.py (agenttalk/)
    service_py = Path(__file__).parent / "service.py"
    if not service_py.exists():
        print(f"WARNING: service.py not found at {service_py} — shortcut may not work.")

    desktop = Path(winshell.desktop())
    shortcut_path = desktop / "AgentTalk.lnk"

    try:
        with winshell.shortcut(str(shortcut_path)) as link:
            link.path = str(pythonw.resolve())
            link.arguments = f'"{service_py.resolve()}"'
            link.working_directory = str(service_py.parent.resolve())
            link.description = "AgentTalk TTS Service"
    except Exception as exc:
        # pywin32 post-install script may not have run — give actionable guidance
        print(
            f"WARNING: Could not create desktop shortcut: {exc}\n"
            "If you see a COM/DLL error, run: python -m pywin32_postinstall -install"
        )
        return

    print(f"  Desktop shortcut created: {shortcut_path}")
```

**Key constraints:**
- Use `winshell.desktop()` not `Path.home() / "Desktop"` — GPO-redirected desktops (see research)
- Catch `ImportError` on `winshell` and print actionable message (pywin32 post-install pitfall)
- Use `os.environ.get("APPDATA", ...)` not `os.path.expanduser("~")` for APPDATA path (anti-pattern from research)
- Streaming download with `response.iter_content(chunk_size=8192)` — not `.content` which loads entire file

<verify>
- `agenttalk/installer.py` exists at `D:/docker/claudetalk/agenttalk/installer.py`
- File defines `download_model()` and `create_shortcut()` at module level
- `download_model()` uses `dest.exists()` skip-if-present guard
- `download_model()` uses `requests.get(..., stream=True)` with `tqdm` progress bar
- `create_shortcut()` calls `winshell.desktop()` (not `Path.home() / "Desktop"`)
- `create_shortcut()` has `ImportError` guard on `winshell` with actionable message
- `APPDATA` resolved via `os.environ.get("APPDATA", ...)` (not `expanduser`)
- File parses without syntax errors: `python -c "import ast; ast.parse(open('agenttalk/installer.py').read()); print('OK')"`
</verify>

<done>Done when `agenttalk/installer.py` exists with `download_model()` and `create_shortcut()` as specified, syntax-check passes, and the file uses `winshell.desktop()` for the desktop path. Partial download recovery (interrupted downloads leaving a zero-byte or truncated file) is handled by documentation: the README Troubleshooting section instructs users to delete the incomplete file from `%APPDATA%\AgentTalk\models\` before re-running `agenttalk setup`. No file-size sanity check is implemented in code — README coverage is the accepted recovery path.</done>
</task>

<task id="06-01-T3" wave="1">
### Task 3: Create agenttalk/cli.py

Create `D:/docker/claudetalk/agenttalk/cli.py` as the `agenttalk` command entry point.

**Exact content to write:**

```python
"""
AgentTalk CLI entry point.

Registered as a console_scripts entry point in pyproject.toml:
    agenttalk = "agenttalk.cli:main"

Subcommands:
    agenttalk setup   — Download model, register hooks, create desktop shortcut

Requirements: INST-01 (CLI entry point), INST-02, INST-03, INST-04
"""
import argparse
import sys


def main() -> None:
    """Main entry point for the `agenttalk` CLI command."""
    parser = argparse.ArgumentParser(
        prog="agenttalk",
        description="AgentTalk — real-time TTS for Claude Code output",
    )
    subparsers = parser.add_subparsers(dest="command", required=True)

    # agenttalk setup
    subparsers.add_parser(
        "setup",
        help=(
            "Download the Kokoro ONNX model, register Claude Code hooks, "
            "and create a desktop shortcut"
        ),
    ).set_defaults(func=_cmd_setup)

    args = parser.parse_args()
    args.func(args)


def _cmd_setup(args: argparse.Namespace) -> None:
    """
    Run the full setup sequence:
      1. Download Kokoro model files (skip if already present)
      2. Register Stop and SessionStart hooks in ~/.claude/settings.json
      3. Create AgentTalk.lnk desktop shortcut

    Order matters: model download first (largest risk of failure), then hooks
    (idempotent merge), then shortcut (idempotent overwrite).
    """
    print("=== AgentTalk Setup ===\n")

    # Step 1: Download Kokoro ONNX model (~310MB total)
    print("Step 1/3: Downloading Kokoro model files...")
    try:
        from agenttalk.installer import download_model
        download_model()
    except Exception as exc:
        print(f"\nERROR in model download: {exc}")
        print("Fix the error and re-run `agenttalk setup`.")
        sys.exit(1)

    # Step 2: Register hooks in ~/.claude/settings.json
    print("\nStep 2/3: Registering Claude Code hooks...")
    try:
        from agenttalk.setup import register_hooks
        register_hooks()
    except Exception as exc:
        print(f"\nERROR registering hooks: {exc}")
        print("Fix the error and re-run `agenttalk setup`.")
        sys.exit(1)

    # Step 3: Create desktop shortcut
    print("\nStep 3/3: Creating desktop shortcut...")
    try:
        from agenttalk.installer import create_shortcut
        create_shortcut()
    except Exception as exc:
        print(f"\nWARNING in shortcut creation: {exc}")
        # Shortcut failure is non-fatal — user can still launch from CLI

    print("\nSetup complete!")
    print("Double-click the AgentTalk shortcut on your desktop to start the service.")
    print("Or run: pythonw agenttalk/service.py")


if __name__ == "__main__":
    main()
```

**Key constraint:** Step 1 (model download) exits with `sys.exit(1)` on failure — it is the only blocker. Step 3 (shortcut creation) is non-fatal: warn but do not exit. This matches the research recommendation.

<verify>
- `agenttalk/cli.py` exists at `D:/docker/claudetalk/agenttalk/cli.py`
- File defines `main()` and `_cmd_setup()` at module level
- `main()` uses `argparse` with `setup` subcommand wired to `_cmd_setup`
- `_cmd_setup()` calls `download_model()`, `register_hooks()`, `create_shortcut()` in that order
- `download_model()` failure causes `sys.exit(1)`; `create_shortcut()` failure prints warning only
- File parses without syntax errors: `python -c "import ast; ast.parse(open('agenttalk/cli.py').read()); print('OK')"`
</verify>

<done>Done when `agenttalk/cli.py` exists with the exact content specified above and `python -c "import ast; ast.parse(open('agenttalk/cli.py').read()); print('cli.py OK')"` prints `cli.py OK`.</done>
</task>

<task id="06-01-T4" wave="2">
### Task 4: Update requirements.txt

Update `D:/docker/claudetalk/requirements.txt` to add the new Phase 6 dependencies (requests, tqdm, pywin32, winshell). These are needed both in the package declaration (pyproject.toml) and for direct `pip install -r requirements.txt` use.

Read the current `requirements.txt` first, then append the four new lines:

```
requests>=2.31
tqdm>=4.66
pywin32>=306
winshell>=0.6
```

The final `requirements.txt` should read:

```
kokoro-onnx==0.5.0
sounddevice==0.5.5
fastapi>=0.110
uvicorn>=0.29
psutil>=5.9
pysbd==0.3.4
pystray>=0.19.5
pycaw>=20251023
requests>=2.31
tqdm>=4.66
pywin32>=306
winshell>=0.6
```

Note: `pywin32` and `winshell` are Windows-only in `pyproject.toml` (platform marker) but `requirements.txt` does not need the platform marker since this project is Windows-only.

<verify>
- `requirements.txt` exists at `D:/docker/claudetalk/requirements.txt`
- File contains exactly 12 dependency lines (no extras, no blank lines between entries)
- All 12 lines present: `kokoro-onnx==0.5.0`, `sounddevice==0.5.5`, `fastapi>=0.110`, `uvicorn>=0.29`, `psutil>=5.9`, `pysbd==0.3.4`, `pystray>=0.19.5`, `pycaw>=20251023`, `requests>=2.31`, `tqdm>=4.66`, `pywin32>=306`, `winshell>=0.6`
</verify>

<done>Done when `requirements.txt` contains all 12 dependency lines including `requests>=2.31`, `tqdm>=4.66`, `pywin32>=306`, `winshell>=0.6`. Verify with: `python -c "lines=[l.strip() for l in open('requirements.txt') if l.strip()]; assert 'requests>=2.31' in lines; assert 'tqdm>=4.66' in lines; assert 'pywin32>=306' in lines; assert 'winshell>=0.6' in lines; assert len(lines)==12; print('requirements.txt OK')"` printing `requirements.txt OK`.</done>
</task>

## Verification

After all tasks complete, verify:

1. `pyproject.toml` exists at `D:/docker/claudetalk/pyproject.toml`
2. `agenttalk/cli.py` exists with `def main()` and `def _cmd_setup()`
3. `agenttalk/installer.py` exists with `def download_model()` and `def create_shortcut()`
4. `pyproject.toml` contains `agenttalk = "agenttalk.cli:main"` in `[project.scripts]`
5. `pyproject.toml` contains `requires-python = ">=3.11,<3.12"`
6. `pyproject.toml` contains `[tool.setuptools.package-data]` with `"agenttalk.commands" = ["*.md"]`
7. `requirements.txt` contains `requests>=2.31` and `tqdm>=4.66`
8. Run `python -c "import ast; ast.parse(open('agenttalk/cli.py').read()); print('cli.py OK')"` from `D:/docker/claudetalk/` — must print `cli.py OK`
9. Run `python -c "import ast; ast.parse(open('agenttalk/installer.py').read()); print('installer.py OK')"` from `D:/docker/claudetalk/` — must print `installer.py OK`

## must_haves

Goal-backward from "A developer on a clean Windows 11 machine runs `pip install agenttalk` then `agenttalk setup` and AgentTalk is fully installed":

- [ ] `pyproject.toml` exists and declares `agenttalk = "agenttalk.cli:main"` as the console_scripts entry point (INST-01 cannot be satisfied without this)
- [ ] `pyproject.toml` declares all runtime dependencies including `requests`, `tqdm`, `pywin32`, `winshell` (pip install on clean machine would fail without these)
- [ ] `pyproject.toml` sets `requires-python = ">=3.11,<3.12"` (pystray crashes on 3.12+; wrong constraint installs onto broken Python)
- [ ] `agenttalk/installer.py` implements `download_model()` with tqdm progress bar and skip-if-exists logic (INST-02)
- [ ] `agenttalk/installer.py` implements `create_shortcut()` using `winshell.desktop()` not hardcoded path (INST-04; GPO-redirected desktops fail otherwise)
- [ ] `agenttalk/cli.py` calls `register_hooks()` from existing `agenttalk/setup.py` (INST-03; do not reimplement)
- [ ] `pyproject.toml` includes `[tool.setuptools.package-data]` for `*.md` in commands and `*.py` in hooks (otherwise slash commands break after pip install — pitfall 2 from research)
